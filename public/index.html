<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japan Tok Mongolia Chatbot</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%231e3a8a'/%3E%3Ctext x='32' y='42' font-size='32' text-anchor='middle' fill='white' font-family='Arial, sans-serif'%3EJ%3C/text%3E%3C/svg%3E">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #020617;
            color: #e2e8f0;
            overflow-x: hidden;
        }

        .aurora-layer {
            position: absolute;
            inset: -10% -20%;
            background: radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.35), transparent 45%),
                        radial-gradient(circle at 80% 0%, rgba(14, 116, 144, 0.35), transparent 40%),
                        radial-gradient(circle at 50% 80%, rgba(251, 191, 36, 0.3), transparent 40%);
            filter: blur(60px);
            z-index: 0;
        }

        .grid-overlay {
            position: absolute;
            inset: 0;
            background-image: linear-gradient(rgba(148, 163, 184, 0.08) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(148, 163, 184, 0.08) 1px, transparent 1px);
            background-size: 60px 60px;
            opacity: 0.4;
            z-index: 0;
        }

        .chat-scroll::-webkit-scrollbar { width: 5px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }

        .message-animation { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
    <div class="aurora-layer" aria-hidden="true"></div>
    <div class="grid-overlay" aria-hidden="true"></div>

    <main class="relative z-10 w-full max-w-6xl mx-auto px-4 py-8 lg:py-16">
        <div class="grid gap-8 lg:grid-cols-[minmax(0,1.1fr)_420px] items-stretch">
            <section class="bg-white/5 border border-white/10 rounded-3xl p-8 backdrop-blur-xl space-y-8 shadow-[0_20px_120px_rgba(14,30,64,0.45)]">
                <div class="inline-flex items-center gap-2 text-xs uppercase tracking-[0.3em] text-amber-200">
                    <span class="w-2 h-2 rounded-full bg-amber-300"></span> Certified Support
                </div>
                <div class="space-y-4">
                    <h1 class="text-3xl sm:text-4xl font-semibold leading-tight text-white">
                        Japan Tok Mongolia —Ü–∞—Ö–∏–º —Ç—É—Å–ª–∞—Ö<br>
                        <span class="text-amber-200">–ø—Ä–µ–º–∏—É–º —Ö–∞–π–ª—Ç—ã–Ω —Ç—É—Ä—à–ª–∞–≥–∞</span>
                    </h1>
                    <p class="text-base text-slate-200 max-w-2xl">
                        –ë–∏–¥ –ú–æ–Ω–≥–æ–ª—ã–Ω —Ö–∞–º–≥–∏–π–Ω –Ω–∞–π–¥–≤–∞—Ä—Ç–∞–π Prius –±–æ–ª–æ–Ω Japan car —Å—ç–ª–±—ç–≥–∏–π–Ω –º—ç–¥—ç—ç–ª–ª–∏–π–≥ 5 –º–∏–Ω—É—Ç —Ç—É—Ç–∞–º —à–∏–Ω—ç—á–∏–ª–∂,
                        —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –∞—Å—É—É–ª—Ç –±“Ø—Ä—Ç –±–∞—Ç–∞–ª–≥–∞–∞—Ç–∞–π ”©–≥”©–≥–¥–ª”©”©—Ä —Ö–∞—Ä–∏—É–ª–¥–∞–≥.
                    </p>
                </div>

                <div class="grid sm:grid-cols-2 gap-4">
                    <div class="rounded-2xl bg-slate-900/60 border border-white/10 p-4">
                        <p class="text-xs uppercase tracking-[0.35em] text-slate-400">–°–µ—Ä–≤–µ—Ä–∏–π–Ω —Ç”©–ª”©–≤</p>
                        <div class="flex items-center gap-3 mt-3">
                            <span id="connection-status" class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></span>
                            <span id="status-text" class="text-sm font-semibold">–°–∏—Å—Ç–µ–º –∞—á–∞–∞–ª–∂ –±–∞–π–Ω–∞...</span>
                        </div>
                    </div>
                    <div id="sheet-indicator" class="rounded-2xl bg-slate-900/60 border border-white/10 p-4 text-sm text-slate-300 opacity-70">
                        <p class="text-xs uppercase tracking-[0.35em] text-slate-400">”®–≥”©–≥–¥–ª–∏–π–Ω —Å–∞–Ω</p>
                        <div class="flex items-center gap-2 mt-3 text-amber-200">
                            <i class="fas fa-database"></i>
                            <span>Data Loading...</span>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900/60 border border-white/10 rounded-2xl p-6 space-y-4">
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-500">–Ø–∞–≥–∞–∞–¥ Japan Tok?</p>
                    <ul class="space-y-3 text-sm text-slate-200">
                        <li class="flex items-start gap-3">
                            <span class="text-amber-300 mt-1">‚ñ∏</span>
                            <div>
                                <p class="font-semibold">313+ –±–∞—Ç–∞–ª–≥–∞–∞—Ç–∞–π –±“Ø—Ä—Ç–≥—ç–ª</p>
                                <p class="text-slate-400 text-xs">Google Sheet-—ç—ç—Å —Å–µ—Ä–≤–µ—Ä –ª“Ø“Ø —à—É—É–¥ —Å–∏–Ω–∫</p>
                            </div>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="text-amber-300 mt-1">‚ñ∏</span>
                            <div>
                                <p class="font-semibold">–ù”®–ê–¢-—Ç—ç–π & –ù”®–ê–¢-–≥“Ø–π “Ø–Ω—ç</p>
                                <p class="text-slate-400 text-xs">–ê–≤—Ç–æ–º–∞—Ç —Ñ–æ—Ä–º–∞—Ç—Ç–∞–π —à—É—É–¥ —Ö–∞—Ä–∏—É–ª—Ç</p>
                            </div>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="text-amber-300 mt-1">‚ñ∏</span>
                            <div>
                                <p class="font-semibold">–õ–æ–≥–∂–∏–ª—Ç & –∞—É–¥–∏—Ç</p>
                                <p class="text-slate-400 text-xs">–•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –∞—Å—É—É–ª—Ç –±“Ø—Ä log-–ª–æ–≥–¥–¥–æ–≥</p>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="flex flex-wrap gap-4">
                    <button class="group inline-flex items-center gap-3 rounded-2xl bg-gradient-to-r from-amber-400 via-amber-300 to-amber-500 text-slate-900 px-6 py-3 font-semibold shadow-[0_15px_35px_rgba(251,191,36,0.35)]">
                        –®—É—É–¥ —Ç—É—Ä—à–∏—Ö
                        <i class="fas fa-arrow-right transition-transform group-hover:translate-x-1"></i>
                    </button>
                    <div class="flex items-center gap-3 text-slate-200 text-sm">
                        <div class="text-2xl">üìû</div>
                        <div>
                            <p class="font-semibold text-white">24/7 –æ–ø–µ—Ä–∞—Ç–æ—Ä</p>
                            <p class="text-xs text-slate-400">99997571 ¬∑ 88105143</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="relative">
                <div class="absolute -inset-[2px] bg-gradient-to-br from-blue-500 via-indigo-500 to-amber-400 opacity-60 blur-lg"></div>
                <div class="relative bg-white text-slate-900 rounded-[28px] border border-white/60 shadow-[0_30px_80px_rgba(15,23,42,0.35)] flex flex-col h-[620px] sm:h-[650px]">
                    <header class="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-slate-900 to-slate-700 flex items-center justify-center text-white font-semibold">
                                JT
                            </div>
                            <div>
                                <p class="text-xs uppercase tracking-[0.4em] text-slate-400">Live Chat</p>
                                <h2 class="text-lg font-semibold">Japan Tok Mongolia</h2>
                            </div>
                        </div>
                        <div class="text-xs text-slate-500 text-right">
                            <p class="font-semibold text-slate-800">Verified Data</p>
                            <p>Gemini ‚Ä¢ Secure</p>
                        </div>
                    </header>

                    <div id="chat-messages" class="flex-1 p-6 space-y-4 overflow-y-auto bg-slate-50 chat-scroll scroll-smooth rounded-b-[28px]">
                        <div class="flex justify-start message-animation">
                            <div class="w-9 h-9 rounded-full bg-slate-900/10 flex items-center justify-center mr-3 mt-1 flex-shrink-0 text-slate-600">
                                <i class="fas fa-robot text-sm"></i>
                            </div>
                            <div class="bg-white/90 text-slate-800 p-4 rounded-3xl rounded-tl-none shadow border border-slate-100 max-w-[85%] text-sm">
                                –°–∞–π–Ω –±–∞–π–Ω–∞ —É—É? <b>Japan Tok Mongolia</b> —Ü–∞—Ö–∏–º —Ç—É—Å–ª–∞—Ö–∞–¥ —Ç–∞–≤—Ç–∞–π –º–æ—Ä–∏–ª.<br>
                                –¢–∞–Ω–¥ —è–º–∞—Ä —Å—ç–ª–±—ç–≥ —Ö—ç—Ä—ç–≥—Ç—ç–π –±–∞–π–Ω–∞ –≤—ç?
                            </div>
                        </div>
                    </div>

                    <form id="chat-form" class="p-4 bg-white border-t border-slate-100 flex items-center gap-3 rounded-b-[28px]">
                        <div class="flex-1 bg-slate-50 border border-slate-200 rounded-2xl px-4 py-2.5 focus-within:border-blue-500 transition">
                            <input type="text" id="user-input" placeholder="–•–∞–π—Ö –±–∞—Ä–∞–∞–≥–∞–∞ –±–∏—á–Ω—ç “Ø“Ø..." required autocomplete="off" disabled
                                   class="w-full bg-transparent text-sm text-slate-800 focus:outline-none"/>
                        </div>
                        <button type="submit" id="send-button" disabled
                                class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white px-4 py-3 rounded-2xl shadow-lg transition-all flex items-center justify-center disabled:opacity-50">
                            <i class="fas fa-paper-plane text-sm"></i>
                        </button>
                    </form>

                    <div id="loader" class="hidden h-1 w-full bg-slate-200 overflow-hidden rounded-b-[28px]">
                        <div class="animate-progress h-full bg-gradient-to-r from-blue-500 to-amber-400 origin-left-right"></div>
                    </div>
                </div>
            </section>
        </div>
    </main>

<style>
    .animate-progress { animation: progress 1s infinite linear; width: 50%; }
    @keyframes progress { 0% { transform: translateX(-100%); } 100% { transform: translateX(250%); } }
</style>

<script>
    // --- SETTINGS ---
    let chatHistory = [];

    // --- DOM Elements ---
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const chatMessages = document.getElementById('chat-messages');
    const statusText = document.getElementById('status-text');
    const statusDot = document.getElementById('connection-status');
    const sheetIndicator = document.getElementById('sheet-indicator');

    const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

    async function retry(operation, { retries = 2, delay = 400 } = {}) {
        let attempt = 0;
        while (true) {
            try {
                return await operation(attempt);
            } catch (error) {
                if (attempt >= retries) throw error;
                await sleep(delay * (attempt + 1));
                attempt += 1;
            }
        }
    }

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} message-animation`;
        
        // Use the same Logo logic for the bot icon if you want (Optional)
        const botIcon = sender === 'bot' ? `<div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-2 mt-1 flex-shrink-0 text-blue-600"><i class="fas fa-robot text-sm"></i></div>` : '';
        
        // Format bold text for bot
        let formattedText = text;
        if(sender === 'bot') {
            formattedText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        }

        div.innerHTML = `${botIcon}<div class="${sender === 'user' ? 'bg-blue-600 text-white' : 'bg-white text-gray-800 border border-gray-100'} p-3 rounded-2xl ${sender === 'user' ? 'rounded-tr-none' : 'rounded-tl-none'} shadow-sm max-w-[85%] text-sm"><p>${formattedText}</p></div>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addTypingIndicator() {
        const div = document.createElement('div');
        div.id = 'typing-indicator';
        div.className = 'flex justify-start message-animation';
        div.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-2 mt-1 flex-shrink-0 text-blue-600"><i class="fas fa-robot text-sm"></i></div>
            <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-100">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div>
            </div>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    // --- 1. ROBUST DATA FETCHING ---
    async function fetchSheetData() {
        try {
            console.log("üì• Fetching product data stats from backend...");
            const json = await retry(async () => {
                const response = await fetch('/api/sheet');
                if (!response.ok) {
                    throw new Error(`Backend returned ${response.status}`);
                }
                return response.json();
            });
            const rowCount = Number(json.count || 0);

            if (!Number.isFinite(rowCount) || rowCount <= 0) {
                throw new Error("Empty or invalid data from backend");
            }

            statusText.textContent = "–°–∏—Å—Ç–µ–º –±—ç–ª—ç–Ω";
            statusDot.className = "w-2 h-2 bg-green-500 rounded-full";
            sheetIndicator.innerHTML = `<i class="fas fa-check-circle text-green-400 mr-1"></i> ${rowCount} –ë–∞—Ä–∞–∞`;
            sheetIndicator.classList.remove('opacity-50');

            userInput.disabled = false;
            sendButton.disabled = false;

        } catch (error) {
            console.error("‚ùå Failed to load data:", error);
            statusText.textContent = "–•–æ–ª–±–æ–ª—Ç—ã–Ω –∞–ª–¥–∞–∞";
            statusDot.className = "w-2 h-2 bg-red-500 rounded-full";
            addMessage("–£—É—á–ª–∞–∞—Ä–∞–π, –∏–Ω—Ç–µ—Ä–Ω—ç—Ç —Ö–æ–ª–±–æ–ª—Ç —ç—Å–≤—ç–ª —Å–µ—Ä–≤–µ—Ä—Ç –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –•—É—É–¥—Å–∞–∞ refresh —Ö–∏–π–Ω—ç “Ø“Ø.", 'bot');
        }
    }

    // --- 2. AI CHAT FUNCTION ---
    async function callChatApi(prompt) {
        return retry(async () => {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: prompt,
                    history: chatHistory.map((entry) => ({
                        role: entry.role === 'model' ? 'assistant' : entry.role,
                        content: entry.parts?.map((part) => part.text).join('\n')
                    }))
                })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'API Error');
            if (!data.reply) throw new Error('Empty response');

            return data;
        });
    }

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = userInput.value.trim();
        if (!text) return;

        addMessage(text, 'user');
        userInput.value = '';
        userInput.disabled = true; // Prevent spamming
        document.getElementById('loader').classList.remove('hidden');
        addTypingIndicator();

        try {
            const { reply, matches } = await callChatApi(text);
            removeTypingIndicator();
            addMessage(reply, 'bot');
            renderMatches(matches);
            
            chatHistory.push({ role: 'user', parts: [{ text }] }, { role: 'model', parts: [{ text: reply }] });
            if (chatHistory.length > 10) chatHistory = chatHistory.slice(-10);

        } catch (error) {
            removeTypingIndicator();
            addMessage("–£—É—á–ª–∞–∞—Ä–∞–π, —Å–∏—Å—Ç–µ–º–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.", 'bot');
        } finally {
            document.getElementById('loader').classList.add('hidden');
            userInput.disabled = false;
            userInput.focus();
        }
    });

    // --- INITIALIZE ON PAGE LOAD ---
    const init = () => fetchSheetData();

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
        init();
    }

    function escapeHtml(value = '') {
        return value.replace(/[&<>"']/g, (char) => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        })[char] || char);
    }

    function renderMatches(matches = []) {
        const existing = document.querySelector('#match-panel');
        if (existing) existing.remove();

        if (!matches?.length) return;

        const panel = document.createElement('div');
        panel.id = 'match-panel';
        panel.className = 'fixed right-4 bottom-4 bg-slate-900/90 backdrop-blur-lg shadow-[0_25px_80px_rgba(2,6,23,0.6)] border border-white/10 rounded-2xl p-4 max-w-sm w-full text-sm space-y-3 text-slate-100';
        panel.innerHTML = `
            <div class="flex items-center justify-between">
                <span class="font-semibold text-white">‚öô –•—ç—Ä—ç–≥–ª—ç—Å—ç–Ω ”©–≥”©–≥–¥”©–ª</span>
                <button class="text-xs text-slate-400 hover:text-white" id="close-match-panel">‚úï</button>
            </div>
            <div class="space-y-2 max-h-60 overflow-y-auto pr-1">
                                ${matches
                  .map((match) => `
                    <div class="border border-white/10 rounded-xl p-3 bg-white/5">
                                                ${match.title ? `<div class="font-semibold text-white">${escapeHtml(match.title)}</div>` : ''}
                                                ${match.tokCode ? `<div class="text-xs text-slate-300">TOK: ${escapeHtml(match.tokCode)}</div>` : ''}
                                                ${match.oem ? `<div class="text-xs text-slate-400">OEM: ${escapeHtml(match.oem)}</div>` : ''}
                                                ${match.wholesaleWithVat ? `<div class="text-xs text-amber-200">“Æ–Ω—ç (–ù”®–ê–¢-—Ç—ç–π): ${escapeHtml(match.wholesaleWithVat)}</div>` : ''}
                                                ${match.wholesaleNoVat ? `<div class="text-xs text-amber-200">“Æ–Ω—ç (–ù”®–ê–¢-–≥“Ø–π): ${escapeHtml(match.wholesaleNoVat)}</div>` : ''}
                    </div>
                `)
                  .join('')}
            </div>
        `;

        document.body.appendChild(panel);
        panel.querySelector('#close-match-panel').addEventListener('click', () => panel.remove());
    }
</script>
</body>
</html>