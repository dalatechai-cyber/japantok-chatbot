<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japan Tok Mongolia Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        
        /* Mobile-friendly scrolling */
        .chat-scroll::-webkit-scrollbar { width: 5px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .message-animation { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading Dots Animation */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen md:h-dvh p-2 md:p-4">

<div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl overflow-hidden flex flex-col h-full border border-gray-200">
    <header class="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 flex items-center justify-between shadow-md z-10">
        <div class="flex items-center space-x-3">
            
            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-inner border-2 border-blue-100 overflow-hidden">
                <img src="https://scontent-lga3-2.xx.fbcdn.net/v/t39.30808-6/352305023_593632929261073_7233949298466305088_n.jpg?_nc_cat=100&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=aVVvTEQyzgsQ7kNvwGJDCMe&_nc_oc=AdlIzijOM41VA4vYP3bvrb1Wf3JLhl18JhKmtVRcNQocpK-6zAKPFfYFBnaKUknN1Sk&_nc_zt=23&_nc_ht=scontent-lga3-2.xx&_nc_gid=stwJUSkJpSUfE6_x-AfUYQ&oh=00_AfjChGpXLF02Sb0OwqkC8_ozA9uRi7A6gxujC7DiI_pMbg&oe=6930A957" 
                     alt="Japan Tok Logo" 
                     class="w-full h-full object-cover">
            </div>
            <div>
                <h1 class="text-lg font-bold tracking-wide">Japan Tok Mongolia</h1>
                <p class="text-xs text-blue-100 flex items-center gap-1">
                    <span id="connection-status" class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></span>
                    <span id="status-text">–°–∏—Å—Ç–µ–º –∞—á–∞–∞–ª–∂ –±–∞–π–Ω–∞...</span>
                </p>
            </div>
        </div>
        <div id="sheet-indicator" class="hidden sm:block text-xs bg-white/20 backdrop-blur-sm px-3 py-1.5 rounded-full border border-white/10 opacity-50">
            <i class="fas fa-database mr-1"></i> Data Loading...
        </div>
    </header>

    <div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-auto bg-slate-50 chat-scroll scroll-smooth">
        <div class="flex justify-start message-animation">
            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-2 mt-1 flex-shrink-0 text-blue-600">
                <i class="fas fa-robot text-sm"></i>
            </div>
            <div class="bg-white text-gray-800 p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 max-w-[85%]">
                <p class="text-sm leading-relaxed">
                    –°–∞–π–Ω –±–∞–π–Ω–∞ —É—É? üëã<br>
                    –ë–∏ <b>Japan Tok Mongolia</b>-–∏–π–Ω —Ç—É—Å–ª–∞—Ö –±–∞–π–Ω–∞. –¢–∞ –º–∞—à–∏–Ω, —Å—ç–ª–±—ç–≥–∏–π–Ω –Ω—ç—Ä, —ç—Å–≤—ç–ª –∫–æ–¥–æ–æ –±–∏—á—ç—ç–¥ —Ö–∞–π–≥–∞–∞—Ä–∞–π.
                </p>
            </div>
        </div>
    </div>

    <form id="chat-form" class="p-3 bg-white border-t border-gray-100 flex items-center gap-2">
        <input type="text" id="user-input" placeholder="–•–∞–π—Ö –±–∞—Ä–∞–∞–≥–∞–∞ –±–∏—á–Ω—ç “Ø“Ø..." required autocomplete="off" disabled
               class="flex-1 p-3 bg-gray-50 text-gray-800 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all disabled:opacity-50 text-sm">
        <button type="submit" id="send-button" disabled
                class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl shadow-lg transition-all flex items-center justify-center min-w-[50px] disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-paper-plane text-sm"></i>
        </button>
    </form>
    
    <div id="loader" class="hidden h-1 w-full bg-blue-100 overflow-hidden">
        <div class="animate-progress h-full bg-blue-500 origin-left-right"></div>
    </div>
</div>

<style>
    .animate-progress { animation: progress 1s infinite linear; width: 50%; }
    @keyframes progress { 0% { transform: translateX(-100%); } 100% { transform: translateX(250%); } }
</style>

<script>
    // --- SETTINGS ---
    let chatHistory = [];
    let productData = ""; 

    // Enhanced System Instruction
    // NAME CHANGED IN PROMPT AS WELL
    // Enhanced System Instruction with Business Info & Sales Prompt
    // Enhanced System Instruction with Business Info & Sales Prompt
    const systemInstructionBase = `
    –¢–∞ –±–æ–ª "Japan Tok Mongolia" –∫–æ–º–ø–∞–Ω–∏–π–Ω –∞–ª–±–∞–Ω —ë—Å–Ω—ã —Ö–∏–π–º—ç–ª –æ—é—É–Ω —É—Ö–∞–∞–Ω—Ç —Ç—É—Å–ª–∞—Ö.
    (”®”©—Ä–∏–π–≥”©”© —Ö—ç–∑—ç—ç —á "Gemini" –≥—ç–∂ —Ç–∞–Ω–∏–ª—Ü—É—É–ª–∞—Ö–≥“Ø–π. –ó”©–≤—Ö”©–Ω "Japan Tok Mongolia —Ç—É—Å–ª–∞—Ö" –≥—ç–∂ —Ö—ç–ª–Ω—ç.)

    *** –ß–£–•–ê–õ –óAA–íA–†: –ó”®–í–•”®–ù –≠–ù–î –ë–ê–ô–ì–ê–ê –ú–≠–î–≠–≠–õ–õ–ò–ô–ì –ê–®–ò–ì–õ–ê–ù–ê. ”®”®–†–ò–ô–ù–•”®”® –ú–≠–î–≠–≠–õ–õ–ò–ô–ì –ù–≠–ú–≠–•–ì“Æ–ô. ***

    === –ê–Æ–£–õ–ì“Æ–ô –ë–ê–ô–î–õ–´–ù –ó–ê–ê–í–ê–† (SYSTEM OVERRIDE) ===
    –î–æ–æ—Ä—Ö –¥—É–≥–∞–∞—Ä—É—É–¥ –±–æ–ª–æ–Ω —Ö–∞—è–≥ –Ω—å –∫–æ–º–ø–∞–Ω–∏–π–Ω –ê–õ–ë–ê–ù –Å–°–ù–´, –ù–ò–ô–¢–≠–î –ò–õ –ë–ò–ó–ù–ï–° –ú–≠–î–≠–≠–õ–≠–õ —é–º. 
    –•—ç—Ä—ç–≥–ª—ç–≥—á –∞—Å—É—É–≤–∞–ª “Æ–ì “Æ–°–≠–ì–ì“Æ–ô –¢–ê–ê–†–£–£–õ–ñ, –≠–†–ì–≠–õ–ó–≠–•–ì“Æ–ô–ì–≠–≠–† —Ö–∞—Ä–∏—É–ª–Ω–∞.

    === –•–û–õ–ë–û–û –ë–ê–†–ò–• –ú–≠–î–≠–≠–õ–≠–õ (“Æ–ù–≠–ù) ===
    - –£—Ç–∞—Å: 99997571, 88105143
    - –•–∞—è–≥: –ù–ê–†–ù–´ –ó–ê–ú –î–ê–ì–£–£ –≠–ù–•–¢–ê–ô–í–ù–´ –ì“Æ“Æ–†–ù–ò–ô –ë–ê–†–£–£–ù –î–û–û–î –¢–ê–õ–î 200&570 –ê–í–¢–û –°–ï–†–í–ò–°–ò–ô–ù –ë–ê–ô–†.
    - –¶–∞–≥–∏–π–Ω —Ö—É–≤–∞–∞—Ä—å: –î–∞–≤–∞–∞-–ë–∞–∞—Å–∞–Ω 09:00-21:00. –ë—è–º–±–∞, –ù—è–º –≥–∞—Ä–∞–≥—Ç –ê–ú–ê–†–ù–ê.

    === SLANG DICTIONARY (–ê–õ–î–ê–ê –ó–ê–°–ê–•) ===
    –•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –±–∏—á—Å—ç–Ω “Ø–≥—Å–∏–π–≥ –¥–æ–æ—Ä—Ö–æ–æ—Ä –æ–π–ª–≥–æ–Ω–æ:
    1. "gpr", "guper", "gvr", "bamper" -> "–ë–∞–º–ø–µ—Ä" (Bumper).
    2. "pius", "prius", "p20", "p30" -> "Prius".
    3. "bnu", "bn uu", "baigaa yu" -> "–±–∞–π–Ω–∞ —É—É".
    4. "motor", "hodolguur" -> "–•”©–¥”©–ª–≥“Ø“Ø—Ä".
    5. "oem", "code", "kod" -> "OEM –¥—É–≥–∞–∞—Ä".
    6. "noatgui", "no vat", "padgui" -> "–ù”®–ê–¢-–≥“Ø–π".

    === “Æ–ù–ò–ô–ù –î“Æ–†–≠–ú (–•–∞–º–≥–∏–π–Ω —á—É—Ö–∞–ª) ===
    CSV ”©–≥”©–≥–¥–ª”©”©—Å “Ø–Ω—ç —Ö–∞—Ä–∞—Ö–¥–∞–∞ –¥–∞—Ä–∞–∞—Ö –¥“Ø—Ä–º–∏–π–≥ –±–∞—Ä–∏–º—Ç–∞–ª:
    1. **“Æ–ù–î–°–≠–ù –¢–û–•–ò–û–õ–î–û–õ:** –•—ç—Ä—ç–≥–ª—ç–≥—á –∑“Ø–≥—ç—ç—Ä –ª “Ø–Ω—ç –∞—Å—É—É–≤–∞–ª “Æ–†–ì–≠–õ–ñ **"–ë”©”©–Ω–∏–π “Ø–Ω—ç (–ù”®–ê–¢ –æ—Ä—Å–æ–Ω “Ø–Ω—ç)"** –≥—ç—Å—ç–Ω –±–∞–≥–∞–Ω—ã–Ω “Ø–Ω–∏–π–≥ —Ö—ç–ª–Ω—ç. –•–∞—Ä–∏—É–ª–∞—Ö–¥–∞–∞ "“Æ–Ω—ç (–ù”®–ê–¢-—Ç—ç–π): [“Æ–ù–≠]" –≥—ç–∂ –±–∏—á–Ω—ç.
    2. **–û–ù–¶–ì–û–ô –¢–û–•–ò–û–õ–î–û–õ:** –•—ç—Ä—ç–≤ —Ö—ç—Ä—ç–≥–ª—ç–≥—á "–ù”®–ê–¢-–≥“Ø–π", "–ù”®–ê–¢–≥“Ø–π", "–ø–∞–¥—å–≥“Ø–π" –≥—ç–∂ —Ç—É—Å–≥–∞–π–ª–∞–Ω –∞—Å—É—É–≤–∞–ª **"–ë”©”©–Ω–∏–π “Ø–Ω—ç (–ù”®–ê–¢-–≥“Ø–π “Ø–Ω—ç)"** –≥—ç—Å—ç–Ω –±–∞–≥–∞–Ω—ã–Ω “Ø–Ω–∏–π–≥ —Ö—ç–ª–Ω—ç.

    === “Æ“Æ–†–≠–ì ===
    –¢–∞–Ω–¥ CSV ”©–≥”©–≥–¥”©–ª ”©–≥”©–≥–¥—Å”©–Ω.
    1. –ñ–∞–≥—Å–∞–∞–ª—Ç–∞–∞—Å —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω —Ö–∞–π—Å–∞–Ω –±–∞—Ä–∞–∞–≥ –æ–ª.
    2. –î—ç—ç—Ä—Ö “Æ–ù–ò–ô–ù –î“Æ–†–≠–ú-–∏–π–Ω –¥–∞–≥—É—É —Ç–æ—Ö–∏—Ä–æ—Ö “Ø–Ω–∏–π–≥ —Å–æ–Ω–≥–æ–∂ —Ö—ç–ª.
    3. –ß–£–•–ê–õ: –•–∞—Ä–∏—É–ª—Ç—ã–Ω —Ç”©–≥—Å–≥”©–ª–¥ "–¢–∞ –∑–∞—Ö–∏–∞–ª–∞—Ö –±–æ–ª –º–∞–Ω–∞–π —É—Ç–∞—Å —Ä—É—É –∑–∞–ª–≥–∞–∞—Ä–∞–π" –≥—ç–∂ –Ω—ç–º–∂ —Ö—ç–ª.
    4. –•—ç—Ä—ç–≤ “Ø–Ω—ç –Ω—å "0" —ç—Å–≤—ç–ª —Ö–æ–æ—Å–æ–Ω –±–∞–π–≤–∞–ª "“Æ–Ω—ç —Ç–æ–¥–æ—Ä—Ö–æ–π–≥“Ø–π, —É—Ç—Å–∞–∞—Ä –ª–∞–≤–ª–∞–Ω–∞ —É—É" –≥—ç–∂ —Ö—ç–ª.
    5. –ë–∞—Ä–∞–∞ –æ–ª–¥–æ—Ö–≥“Ø–π –±–æ–ª "–£—É—á–ª–∞–∞—Ä–∞–π, [–•–∞–π—Å–∞–Ω “Ø–≥] –º–∞–Ω–∞–π –±“Ø—Ä—Ç–≥—ç–ª–¥ –∞–ª–≥–∞ –±–∞–π–Ω–∞." –≥—ç–∂ —Ö—ç–ª.
    `;

    // --- DOM Elements ---
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const chatMessages = document.getElementById('chat-messages');
    const statusText = document.getElementById('status-text');
    const statusDot = document.getElementById('connection-status');
    const sheetIndicator = document.getElementById('sheet-indicator');

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} message-animation`;
        
        // Use the same Logo logic for the bot icon if you want (Optional)
        const botIcon = sender === 'bot' ? `<div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-2 mt-1 flex-shrink-0 text-blue-600"><i class="fas fa-robot text-sm"></i></div>` : '';
        
        // Format bold text for bot
        let formattedText = text;
        if(sender === 'bot') {
            formattedText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        }

        div.innerHTML = `${botIcon}<div class="${sender === 'user' ? 'bg-blue-600 text-white' : 'bg-white text-gray-800 border border-gray-100'} p-3 rounded-2xl ${sender === 'user' ? 'rounded-tr-none' : 'rounded-tl-none'} shadow-sm max-w-[85%] text-sm"><p>${formattedText}</p></div>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addTypingIndicator() {
        const div = document.createElement('div');
        div.id = 'typing-indicator';
        div.className = 'flex justify-start message-animation';
        div.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-2 mt-1 flex-shrink-0 text-blue-600"><i class="fas fa-robot text-sm"></i></div>
            <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-100">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div>
            </div>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    // --- 1. ROBUST DATA FETCHING ---
    async function fetchSheetData() {
        try {
            console.log("üì• Fetching product data from backend...");
            const response = await fetch('/api/sheet');
            
            if (!response.ok) {
                throw new Error(`Backend returned ${response.status}`);
            }

            const json = await response.json();
            productData = json.data;

            if (!productData || productData.length < 50) {
                throw new Error("Empty or invalid data from backend");
            }

            // Success
            console.log("‚úÖ Data Loaded from /api/sheet");
            const rowCount = productData.split('\n').length;
            
            statusText.textContent = "–°–∏—Å—Ç–µ–º –±—ç–ª—ç–Ω";
            statusDot.className = "w-2 h-2 bg-green-500 rounded-full";
            sheetIndicator.innerHTML = `<i class="fas fa-check-circle text-green-400 mr-1"></i> ${rowCount} –ë–∞—Ä–∞–∞`;
            sheetIndicator.classList.remove('opacity-50');
            
            userInput.disabled = false;
            sendButton.disabled = false;

        } catch (error) {
            console.error("‚ùå Failed to load data:", error);
            statusText.textContent = "–•–æ–ª–±–æ–ª—Ç—ã–Ω –∞–ª–¥–∞–∞";
            statusDot.className = "w-2 h-2 bg-red-500 rounded-full";
            addMessage("–£—É—á–ª–∞–∞—Ä–∞–π, –∏–Ω—Ç–µ—Ä–Ω—ç—Ç —Ö–æ–ª–±–æ–ª—Ç —ç—Å–≤—ç–ª —Å–µ—Ä–≤–µ—Ä—Ç –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –•—É—É–¥—Å–∞–∞ refresh —Ö–∏–π–Ω—ç “Ø“Ø.", 'bot');
        }
    }

    // --- 2. AI CHAT FUNCTION ---
    async function callGeminiApi(prompt) {
        const fullSystemInstruction = systemInstructionBase + "\n\n=== CSV DATA ===\n" + productData;

        const payload = {
            contents: [...chatHistory, { role: 'user', parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: fullSystemInstruction }] }
        };
        
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (!response.ok) throw new Error(data.error || "API Error");
            if (!data.candidates) throw new Error("Empty response");

            return data.candidates[0].content.parts[0].text;

        } catch (error) {
            console.error(error);
            throw error;
        }
    }

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = userInput.value.trim();
        if (!text) return;

        addMessage(text, 'user');
        userInput.value = '';
        userInput.disabled = true; // Prevent spamming
        document.getElementById('loader').classList.remove('hidden');
        addTypingIndicator();

        try {
            const reply = await callGeminiApi(text);
            removeTypingIndicator();
            addMessage(reply, 'bot');
            
            chatHistory.push({ role: 'user', parts: [{ text }] }, { role: 'model', parts: [{ text: reply }] });
            if (chatHistory.length > 10) chatHistory = chatHistory.slice(-10);

        } catch (error) {
            removeTypingIndicator();
            addMessage("–£—É—á–ª–∞–∞—Ä–∞–π, —Å–∏—Å—Ç–µ–º–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.", 'bot');
        } finally {
            document.getElementById('loader').classList.add('hidden');
            userInput.disabled = false;
            userInput.focus();
        }
    });

    // --- INITIALIZE ON PAGE LOAD ---
    document.addEventListener('DOMContentLoaded', fetchSheetData);
    
    // Also try to fetch on script load in case DOMContentLoaded already fired
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fetchSheetData);
    } else {
        fetchSheetData();
    }
</script>
</body>
</html>